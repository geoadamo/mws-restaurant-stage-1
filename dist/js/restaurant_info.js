let restaurant,reviews;var map,marker;let review_form;function MapReady(){document.getElementById("restaurant-name").focus()}window.initMap=(()=>{self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),self.restaurant&&(self.map.setCenter(self.restaurant.latlng),self.marker||(self.marker=DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))),google.maps.event.addListenerOnce(self.map,"tilesloaded",MapReady)}),window.addEventListener("offline",e=>{toggleOffline(!0)}),window.addEventListener("online",e=>{toggleOffline(!1)}),toggleOffline=((e,t=!0)=>{e?document.getElementById("offline").style.visibility="visible":(document.getElementById("offline").style.visibility="hidden",t&&DBHelper.syncOfflineData())}),formSubmit=(e=>{e.preventDefault();let t=new FormData;for(let e of self.review_form)"submit"!=e.type&&("restaurant_id"==e.name?t.append(e.name,parseInt(e.value)):t.append(e.name,e.value));DBHelper.addReview(t).then(e=>{e&&(self.reviews=null,fetchRestaurantReviews((e,t)=>{if(e)console.error(e);else{const e=document.getElementById("reviews-list");e.innerHTML="";let r=1;t.forEach(t=>{e.appendChild(createReviewHTML(t,r)),r++}),document.getElementById("filtered-results").innerHTML="<p>Review added</p>",self.review_form.reset()}}))})}),document.addEventListener("DOMContentLoaded",e=>{toggleOffline(!navigator.onLine,!1),navigator.onLine?DBHelper.syncOfflineData().then(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(fillBreadcrumb(),self.map&&(self.map.setCenter(self.restaurant.latlng),self.marker=DBHelper.mapMarkerForRestaurant(self.restaurant,self.map)),fetchRestaurantReviews((e,t)=>{e?console.error(e):fillReviewsHTML()}))})}):fetchRestaurantFromURL((e,t)=>{e?console.error(e):(fillBreadcrumb(),self.map&&(self.map.setCenter(self.restaurant.latlng),self.marker=DBHelper.mapMarkerForRestaurant(self.restaurant,self.map)),fetchRestaurantReviews((e,t)=>{e?console.error(e):fillReviewsHTML()}))}),self.review_form=document.getElementById("review-form"),self.review_form.addEventListener("submit",formSubmit)}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,r)=>{self.restaurant=r,r?(e(null,r),fillRestaurantHTML()):console.error(t)}):(error="No restaurant id in URL",e(error,null))}),fetchRestaurantReviews=(e=>{self.reviews?e(null,self.reviews):self.restaurant?DBHelper.fetchReviewsByRestaurantId(self.restaurant.id,(t,r)=>{self.reviews=r,r?e(null,r):console.error(t)}):console.error("Could not get reviews")}),fillRestaurantHTML=((e=self.restaurant)=>{const t=document.getElementById("restaurant-name");t.innerHTML=e.name,t.setAttribute("aria-label",`${e.name}, ${e.cuisine_type} cuisine`);const r=document.getElementById("restaurant-img");r.className="restaurant-img",r.alt=`${e.name} ${e.cuisine_type} Cuisine`,r.src=DBHelper.imageUrlForRestaurant(e);const a=document.getElementById("restaurant-address");a.innerHTML=e.address,a.setAttribute("aria-label",`address ${e.address}`),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type;let n=document.getElementById("fav");e.is_favorite&&DBHelper.parseBoolean(e.is_favorite)&&(n.src="icons/favorite.png",n.setAttribute("data-is-favorite","true"),n.setAttribute("title","Click to mark as not favorite!"),n.setAttribute("aria-label","Press enter to mark as not favorite!")),n.addEventListener("click",e=>{toggleFavorite(e.target)}),n.addEventListener("keydown",e=>{13==e.keyCode&&toggleFavorite(e.target)}),document.getElementById("form_restaurant_id").value=self.restaurant.id,e.operating_hours&&fillRestaurantHoursHTML()}),toggleFavorite=(e=>{let t=self.restaurant.id,r=DBHelper.parseBoolean(e.getAttribute("data-is-favorite"));DBHelper.toggleFavorite(t,!r),1==!r?(e.src="icons/favorite.png",e.setAttribute("data-is-favorite","true"),e.setAttribute("title","Click to mark as not favorite!"),e.setAttribute("aria-label","Press enter to mark as not favorite!"),document.getElementById("filtered-results").innerHTML="<p>Υου marked as favorite</p>"):(e.src="icons/notfavorite.png",e.setAttribute("data-is-favorite","false"),e.setAttribute("title","Click to mark as favorite!"),e.setAttribute("aria-label","Press enter to mark as favorite!"),document.getElementById("filtered-results").innerHTML="<p>Υου marked as not favorite</p>")}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");for(let r in e){const a=document.createElement("tr"),n=document.createElement("td");n.innerHTML=r,n.setAttribute("tabindex",0),n.setAttribute("aria-label",`${r} : ${e[r]}`),0,a.appendChild(n);const i=document.createElement("td");i.innerHTML=e[r],a.appendChild(i),t.appendChild(a)}}),fillReviewsHTML=((e=self.reviews)=>{const t=document.getElementById("reviews-container"),r=document.createElement("h3");if(r.innerHTML="Reviews",r.setAttribute("aria-label",`${e.length} reviews`),r.setAttribute("tabindex",0),t.appendChild(r),!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void t.appendChild(e)}const a=document.createElement("ul");a.setAttribute("id","reviews-list");let n=1;e.forEach(e=>{a.appendChild(createReviewHTML(e,n)),n++}),t.appendChild(a)}),createReviewHTML=((e,t)=>{const r=document.createElement("li");r.setAttribute("tabindex",0),r.setAttribute("aria-label",`Review ${t}`);const a=document.createElement("div");a.className="review-inner";const n=document.createElement("h4");n.className="review-reviewer",n.setAttribute("tabindex",0),n.setAttribute("aria-label",`reviewer name ${e.name} date ${e.date}`),n.innerHTML=e.name;const i=document.createElement("p");i.className="review-date",i.innerHTML=DBHelper.toDate(e.updatedAt);const l=document.createElement("table");l.setAttribute("width","100%");const s=document.createElement("tbody"),o=document.createElement("tr"),d=document.createElement("td"),m=document.createElement("td");d.setAttribute("align","left"),d.appendChild(n),m.setAttribute("align","right"),m.appendChild(i),o.appendChild(d),o.appendChild(m),s.appendChild(o),l.appendChild(s),r.appendChild(l);const u=document.createElement("p");u.className="review-rating",u.setAttribute("aria-label",`review rating ${e.rating}`),u.innerHTML=`Rating: ${e.rating}`,u.setAttribute("tabindex",0),a.appendChild(u);const c=document.createElement("p");return c.setAttribute("aria-label",`review, ${e.comments}`),c.innerHTML=e.comments,c.setAttribute("tabindex",0),a.appendChild(c),r.appendChild(a),r}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),r=document.createElement("li");r.innerHTML=e.name,t.appendChild(r)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const r=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return r?r[2]?decodeURIComponent(r[2].replace(/\+/g," ")):"":null});